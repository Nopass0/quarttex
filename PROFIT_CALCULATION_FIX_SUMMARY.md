# Итоговый отчет об исправлениях расчета прибыли

## Выполненные исправления

### 1. Устранено двойное применение KKK при заморозке баланса

**Проблема:** Коэффициент корректировки курса (KKK) применялся дважды:
- Первый раз при получении курса от Rapira (`rapiraService.getRateWithKkk()`)
- Второй раз в функции `calculateFreezingParams()`

**Решение:** В файле `/home/user/projects/chase/backend/src/routes/merchant/index.ts`:
- Строки 824-835: Прямой расчет заморозки без использования `calculateFreezingParams`
- Строки 1159-1169: Заменен вызов `calculateFreezingParams` на прямой расчет

```typescript
// Рассчитываем заморозку напрямую с курсом, который уже содержит KKK
const frozenUsdtAmount = Math.ceil((amount / rapiraRateWithKkk) * 100) / 100;
const calculatedCommission = Math.ceil((frozenUsdtAmount * feeInPercent / 100) * 100) / 100;
const totalRequired = frozenUsdtAmount + calculatedCommission;
```

### 2. Добавлен расчет прибыли при ручном подтверждении транзакции

**Файл:** `/home/user/projects/chase/backend/src/routes/trader/bt-entrance.ts`
**Строки:** 198-259

При нажатии трейдером кнопки "Подтвердить платеж":
- Получаются настройки комиссии трейдера из `traderMerchant`
- Рассчитывается потраченная сумма USDT: `spentUsdt = amount / rate`
- Рассчитывается прибыль: `traderProfit = spentUsdt * (commissionPercent / 100)`
- Обновляются балансы трейдера (размораживание, списание, начисление прибыли)

### 3. Исправлен расчет прибыли в автоматической обработке уведомлений

**Файл:** `/home/user/projects/chase/backend/src/services/NotificationAutoProcessorService.ts`
**Строки:** 330-374

При автоматическом подтверждении транзакции через уведомления:
- Используется та же формула расчета прибыли
- Прибыль сохраняется в поле `traderProfit` транзакции
- Обновляются все необходимые балансы

### 4. Обновлен интерфейс трейдера для отображения сохраненной прибыли

**Файл:** `/home/user/projects/chase/backend/src/routes/trader/transactions.ts`

Вместо расчета прибыли "на лету" теперь используется сохраненное значение из базы данных:
```typescript
const profit = tx.traderProfit || 0;
```

## Ключевые моменты

1. **Единая формула расчета прибыли:**
   ```typescript
   spentUsdt = amount / rate
   traderProfit = spentUsdt * (commissionPercent / 100)
   ```

2. **Поле `rate` всегда содержит курс Rapira с уже примененным KKK**

3. **Поле `merchantRate` используется только для отображения мерчанту**

4. **При заморозке баланса KKK не применяется повторно**

5. **Прибыль сохраняется в базе данных в поле `traderProfit`**

## Логирование для отладки

Добавлено логирование в ключевых местах:
- `[Merchant] Freezing calculation:` - при расчете заморозки
- `[BT-Entrance] Manual confirmation:` - при ручном подтверждении
- `Profit calculation:` - при автоматическом подтверждении

## Тестирование

Создан файл `/home/user/projects/chase/backend/src/tests/freezing-profit.test.ts` с тестами:
- Проверка расчета заморозки с учетом KKK
- Проверка расчета прибыли трейдера
- Проверка создания транзакции и заморозки баланса
- Проверка расчета прибыли при завершении транзакции

## Рекомендации

1. Протестировать создание новой транзакции и убедиться, что баланс корректно замораживается
2. Проверить, что при подтверждении транзакции (как ручном, так и автоматическом) прибыль рассчитывается правильно
3. Убедиться, что в интерфейсе трейдера отображается корректная прибыль по каждой сделке