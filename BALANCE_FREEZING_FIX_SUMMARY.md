# Исправление заморозки баланса при создании транзакций

## Проблема
Баланс трейдера не замораживался при получении сделки через:
1. Админку (моковые сделки)
2. Тестовые транзакции через админский API

При этом в мерчантском API заморозка работала корректно.

## Решение

### 1. Создан общий модуль для заморозки баланса
**Файл:** `/home/user/projects/chase/backend/src/utils/transaction-freezing.ts`

Содержит функции:
- `calculateTransactionFreezing()` - расчет параметров заморозки
- `freezeTraderBalance()` - заморозка баланса трейдера
- `createTransactionWithFreezing()` - создание транзакции с заморозкой

### 2. Обновлен админский API

#### POST /admin/transactions/create
**Файл:** `/home/user/projects/chase/backend/src/routes/admin/transactions.ts`
**Строки:** 165-211

Теперь при создании транзакции:
1. Проверяется, является ли `userId` трейдером
2. Если это IN транзакция - рассчитываются параметры заморозки
3. Замораживается баланс трейдера
4. Параметры заморозки сохраняются в транзакции

#### PUT /admin/transactions/trader
**Строки:** 696-807

При назначении/смене трейдера:
1. Если убираем трейдера (traderId = null) - размораживаем его баланс
2. Если меняем трейдера - размораживаем баланс старого трейдера
3. Для нового трейдера рассчитываем и замораживаем баланс
4. Обновляем параметры заморозки в транзакции

#### POST /admin/transactions/test/in
**Строки:** 968-1038

Для тестовых транзакций:
1. Автоматически находится подходящий реквизит и трейдер
2. Рассчитываются параметры заморозки
3. Замораживается баланс трейдера
4. Создается транзакция с параметрами заморозки

## Ключевые изменения

1. **Унифицированная логика** - одинаковые расчеты для всех способов создания транзакций
2. **Атомарность операций** - использование транзакций БД для консистентности
3. **Логирование** - добавлены логи для отладки заморозки/разморозки
4. **Обработка ошибок** - проверка достаточности баланса перед заморозкой

## Формула расчета заморозки

```typescript
frozenUsdtAmount = Math.ceil((amount / rate) * 100) / 100
calculatedCommission = Math.ceil((frozenUsdtAmount * feeInPercent / 100) * 100) / 100
totalRequired = frozenUsdtAmount + calculatedCommission
```

Где:
- `amount` - сумма транзакции в RUB
- `rate` - курс с уже примененным KKK
- `feeInPercent` - процент комиссии трейдера

## Важно

1. Заморозка происходит **только для IN транзакций**
2. При смене/удалении трейдера баланс автоматически размораживается
3. Все операции выполняются в рамках транзакции БД для атомарности
4. Параметры заморозки сохраняются в транзакции для последующей разморозки

## Результат

Теперь баланс трейдера корректно замораживается при получении сделки независимо от способа ее создания:
- Через мерчантское API ✅
- Через админку (моковые сделки) ✅  
- Через тестовый API ✅
- При назначении трейдера существующей транзакции ✅